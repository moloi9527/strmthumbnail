<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emby å°é¢ç®¡ç†å™¨</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const Play = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const FolderOpen = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" /></svg>;
        const Settings = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>;
        const CheckCircle = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const Loader = ({ className }) => <svg className={className} fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>;
        const FileText = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>;
        const Download = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>;
        const Trash2 = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
        const RefreshCw = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>;
        const AlertCircle = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const Lock = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>;
        const User = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>;
        const LogOut = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>;
        const Key = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" /></svg>;

        function LoginPage({ onLogin }) {
          const [username, setUsername] = useState('');
          const [password, setPassword] = useState('');
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState('');

          const handleLogin = async (e) => {
            e.preventDefault();
            setError('');
            setLoading(true);

            try {
              const response = await fetch(`${window.location.origin}/api/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
              });

              const data = await response.json();

              if (data.success) {
                localStorage.setItem('auth-token', data.token);
                localStorage.setItem('username', data.username);
                onLogin(data.token, data.username);
              } else {
                setError(data.error || 'ç™»å½•å¤±è´¥');
              }
            } catch (err) {
              setError('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
            } finally {
              setLoading(false);
            }
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 flex items-center justify-center p-6">
              <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-8 w-full max-w-md border border-white/20">
                <div className="text-center mb-8">
                  <div className="flex items-center justify-center gap-3 mb-2">
                    <Lock className="w-10 h-10 text-purple-300" />
                    <h1 className="text-3xl font-bold text-white">ç™»å½•</h1>
                  </div>
                  <p className="text-purple-200">Emby å°é¢ç®¡ç†å™¨</p>
                </div>

                {error && (
                  <div className="bg-red-500/20 border border-red-400/50 rounded-lg p-3 mb-4 flex items-center gap-2">
                    <AlertCircle className="w-5 h-5 text-red-300" />
                    <span className="text-red-200 text-sm">{error}</span>
                  </div>
                )}

                <form onSubmit={handleLogin} className="space-y-4">
                  <div>
                    <label className="block text-purple-200 text-sm mb-2">ç”¨æˆ·å</label>
                    <div className="relative">
                      <User className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-purple-300" />
                      <input
                        type="text"
                        value={username}
                        onChange={(e) => setUsername(e.target.value)}
                        placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                        className="w-full pl-10 pr-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-purple-300/50 focus:outline-none focus:border-purple-400"
                        required
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-purple-200 text-sm mb-2">å¯†ç </label>
                    <div className="relative">
                      <Key className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-purple-300" />
                      <input
                        type="password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        placeholder="è¯·è¾“å…¥å¯†ç "
                        className="w-full pl-10 pr-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-purple-300/50 focus:outline-none focus:border-purple-400"
                        required
                      />
                    </div>
                  </div>

                  <button
                    type="submit"
                    disabled={loading}
                    className="w-full py-3 bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-white font-semibold transition-all flex items-center justify-center gap-2"
                  >
                    {loading ? (
                      <>
                        <Loader className="w-5 h-5 animate-spin" />
                        ç™»å½•ä¸­...
                      </>
                    ) : (
                      'ç™»å½•'
                    )}
                  </button>
                </form>

                <div className="mt-6 text-center">
                  <p className="text-purple-300 text-sm">
                    é¦–æ¬¡ç™»å½•é»˜è®¤è´¦å·ï¼šadmin / emby123456
                  </p>
                  <p className="text-purple-400 text-xs mt-1">
                    è¯·ç™»å½•åç«‹å³ä¿®æ”¹å¯†ç 
                  </p>
                </div>
              </div>
            </div>
          );
        }

        function App() {
          const [authenticated, setAuthenticated] = useState(false);
          const [token, setToken] = useState('');
          const [username, setUsername] = useState('');
          const [checking, setChecking] = useState(true);

          useEffect(() => {
            const savedToken = localStorage.getItem('auth-token');
            const savedUsername = localStorage.getItem('username');
            
            if (savedToken) {
              verifyToken(savedToken, savedUsername);
            } else {
              setChecking(false);
            }
          }, []);

          const verifyToken = async (token, username) => {
            try {
              const response = await fetch(`${window.location.origin}/api/auth/verify`, {
                headers: { 'Authorization': `Bearer ${token}` }
              });

              if (response.ok) {
                setToken(token);
                setUsername(username);
                setAuthenticated(true);
              } else {
                localStorage.removeItem('auth-token');
                localStorage.removeItem('username');
              }
            } catch (err) {
              console.error('éªŒè¯å¤±è´¥:', err);
            } finally {
              setChecking(false);
            }
          };

          const handleLogin = (newToken, newUsername) => {
            setToken(newToken);
            setUsername(newUsername);
            setAuthenticated(true);
          };

          const handleLogout = async () => {
            try {
              await fetch(`${window.location.origin}/api/auth/logout`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
              });
            } catch (err) {
              console.error('ç™»å‡ºå¤±è´¥:', err);
            }

            localStorage.removeItem('auth-token');
            localStorage.removeItem('username');
            setAuthenticated(false);
            setToken('');
            setUsername('');
          };

          if (checking) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 flex items-center justify-center">
                <Loader className="w-12 h-12 text-purple-300 animate-spin" />
              </div>
            );
          }

          if (!authenticated) {
            return <LoginPage onLogin={handleLogin} />;
          }

          return <EmbyThumbnailManager token={token} username={username} onLogout={handleLogout} />;
        }

        function EmbyThumbnailManager({ token, username, onLogout }) {
          const [config, setConfig] = useState({
            embyUrl: '',
            embyApiKey: '',
            strmDir: '',
            outputDir: '',
            coverMode: '1',
            concurrency: 4,
            maxRetries: 2
          });
          
          const [savedConfig, setSavedConfig] = useState(null);
          const [currentPath, setCurrentPath] = useState('');
          const [fileTree, setFileTree] = useState([]);
          const [loadingTree, setLoadingTree] = useState(false);
          const [processing, setProcessing] = useState(false);
          const [progress, setProgress] = useState({ total: 0, processed: 0, success: 0, failed: 0 });
          const [logs, setLogs] = useState([]);
          const [showBrowser, setShowBrowser] = useState(false);
          const [browserMode, setBrowserMode] = useState('strm');
          const [failedFiles, setFailedFiles] = useState([]);
          const [apiConnected, setApiConnected] = useState(false);
          const [testingConnection, setTestingConnection] = useState(false);
          const [showPasswordModal, setShowPasswordModal] = useState(false);

          const API_BASE = window.location.origin + '/api';

          // å°è£… fetch è¯·æ±‚ï¼Œè‡ªåŠ¨æ·»åŠ  token
          const authFetch = async (url, options = {}) => {
            return fetch(url, {
              ...options,
              headers: {
                ...options.headers,
                'Authorization': `Bearer ${token}`
              }
            });
          };

          useEffect(() => {
            loadSavedConfig();
          }, []);

          const loadSavedConfig = () => {
            const stored = localStorage.getItem('emby-config');
            if (stored) {
              const parsed = JSON.parse(stored);
              setSavedConfig(parsed);
              setConfig(prev => ({ ...prev, ...parsed }));
              addLog('âœ… å·²åŠ è½½ä¿å­˜çš„é…ç½®', 'success');
            }
          };

          const saveConfig = () => {
            localStorage.setItem('emby-config', JSON.stringify(config));
            setSavedConfig(config);
            addLog('âœ… é…ç½®å·²ä¿å­˜', 'success');
          };

          const testEmbyConnection = async () => {
            if (!config.embyUrl || !config.embyApiKey) {
              addLog('âŒ è¯·å…ˆå¡«å†™ Emby æœåŠ¡å™¨åœ°å€å’Œ API å¯†é’¥', 'error');
              return;
            }

            setTestingConnection(true);
            try {
              const response = await authFetch(`${API_BASE}/test-emby`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  embyUrl: config.embyUrl,
                  embyApiKey: config.embyApiKey
                })
              });

              const data = await response.json();
              if (data.success) {
                setApiConnected(true);
                addLog(`âœ… Emby è¿æ¥æˆåŠŸï¼æœåŠ¡å™¨åç§°: ${data.serverName}`, 'success');
              } else {
                setApiConnected(false);
                addLog('âŒ Emby è¿æ¥å¤±è´¥: ' + data.error, 'error');
              }
            } catch (error) {
              setApiConnected(false);
              addLog('âŒ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ï¼Œè¯·ç¡®ä¿åç«¯æ­£åœ¨è¿è¡Œ', 'error');
            } finally {
              setTestingConnection(false);
            }
          };

          const browseFileSystem = async (path) => {
            setLoadingTree(true);
            try {
              const response = await authFetch(`${API_BASE}/browse?path=${encodeURIComponent(path)}`);
              const data = await response.json();
              
              if (data.success) {
                setFileTree(data.items);
                setCurrentPath(data.currentPath);
              } else {
                addLog('âŒ æ— æ³•è¯»å–ç›®å½•: ' + data.error, 'error');
              }
            } catch (error) {
              addLog('âŒ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡', 'error');
              setFileTree([]);
            } finally {
              setLoadingTree(false);
            }
          };

          const openFileBrowser = async (mode) => {
            setBrowserMode(mode);
            setShowBrowser(true);
            const startPath = mode === 'strm' ? (config.strmDir || '/') : (config.outputDir || '/');
            await browseFileSystem(startPath);
          };

          const navigateFolder = async (item) => {
            if (item.type === 'directory') {
              await browseFileSystem(item.path);
            }
          };

          const selectCurrentFolder = () => {
            if (browserMode === 'strm') {
              setConfig(prev => ({ ...prev, strmDir: currentPath }));
            } else {
              setConfig(prev => ({ ...prev, outputDir: currentPath }));
            }
            setShowBrowser(false);
            addLog(`ğŸ“ å·²é€‰æ‹©ç›®å½•: ${currentPath}`, 'info');
          };

          const addLog = (message, type = 'info') => {
            const timestamp = new Date().toLocaleTimeString();
            setLogs(prev => [...prev, { time: timestamp, message, type }]);
          };

          const processFiles = async (files, isRetry = false) => {
            try {
              const processResponse = await authFetch(`${API_BASE}/process`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: files, config: config })
              });

              const reader = processResponse.body.getReader();
              const decoder = new TextDecoder();

              while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n').filter(line => line.trim());

                for (const line of lines) {
                  if (line.startsWith('data: ')) {
                    try {
                      const data = JSON.parse(line.slice(6));
                      
                      if (data.type === 'progress') {
                        setProgress(data.progress);
                      } else if (data.type === 'log') {
                        addLog(data.message, data.level);
                      } else if (data.type === 'failed') {
                        setFailedFiles(prev => [...prev, data.file]);
                      } else if (data.type === 'complete') {
                        if (!isRetry) {
                          addLog('ğŸ åˆæ¬¡å¤„ç†å®Œæˆï¼', 'success');
                        } else {
                          addLog('ğŸ é‡è¯•å®Œæˆï¼', 'success');
                        }
                      }
                    } catch (e) {
                      console.error('è§£ææ•°æ®å¤±è´¥:', e);
                    }
                  }
                }
              }
            } catch (error) {
              throw error;
            }
          };

          const startProcessing = async () => {
            if (!config.embyUrl || !config.embyApiKey || !config.strmDir) {
              addLog('âŒ è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯', 'error');
              return;
            }

            setProcessing(true);
            setLogs([]);
            setProgress({ total: 0, processed: 0, success: 0, failed: 0 });
            setFailedFiles([]);

            try {
              addLog('ğŸ” æ­£åœ¨æ‰«æ .strm æ–‡ä»¶...', 'info');
              const scanResponse = await authFetch(`${API_BASE}/scan`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ strmDir: config.strmDir })
              });

              const scanData = await scanResponse.json();
              if (!scanData.success) {
                addLog('âŒ æ‰«æå¤±è´¥: ' + scanData.error, 'error');
                setProcessing(false);
                return;
              }

              const totalFiles = scanData.files.length;
              if (totalFiles === 0) {
                addLog('âš ï¸ æœªæ‰¾åˆ° .strm æ–‡ä»¶', 'warning');
                setProcessing(false);
                return;
              }

              addLog(`ğŸ“Š æ‰¾åˆ° ${totalFiles} ä¸ª .strm æ–‡ä»¶`, 'info');
              setProgress(prev => ({ ...prev, total: totalFiles }));

              // åˆæ¬¡å¤„ç†
              await processFiles(scanData.files, false);

              // è‡ªåŠ¨é‡è¯•å¤±è´¥çš„æ–‡ä»¶
              const maxRetries = parseInt(config.maxRetries);
              for (let retry = 1; retry <= maxRetries; retry++) {
                // ç­‰å¾…ä¸€ä¸‹å†æ£€æŸ¥å¤±è´¥åˆ—è¡¨
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                setFailedFiles(currentFailed => {
                  if (currentFailed.length > 0) {
                    addLog(`ğŸ” ç¬¬ ${retry} è½®é‡è¯• (${currentFailed.length} ä¸ªå¤±è´¥æ–‡ä»¶)`, 'info');
                    // å¼‚æ­¥æ‰§è¡Œé‡è¯•
                    processFiles(currentFailed, true).catch(err => {
                      addLog('âŒ é‡è¯•å‡ºé”™: ' + err.message, 'error');
                    });
                  }
                  return currentFailed;
                });

                // ç­‰å¾…é‡è¯•å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 3000));
              }

              addLog('ğŸ‰ æ‰€æœ‰å¤„ç†æµç¨‹å®Œæˆï¼', 'success');
            } catch (error) {
              addLog('âŒ å¤„ç†å‡ºé”™: ' + error.message, 'error');
            } finally {
              setProcessing(false);
            }
          };

          const retryFailed = async () => {
            if (failedFiles.length === 0) {
              addLog('âš ï¸ æ²¡æœ‰å¤±è´¥çš„æ–‡ä»¶éœ€è¦é‡è¯•', 'warning');
              return;
            }

            addLog(`ğŸ” æ‰‹åŠ¨é‡è¯• ${failedFiles.length} ä¸ªå¤±è´¥çš„æ–‡ä»¶`, 'info');
            const filesToRetry = [...failedFiles];
            setFailedFiles([]);
            setProcessing(true);

            try {
              await processFiles(filesToRetry, true);
            } catch (error) {
              addLog('âŒ é‡è¯•å¤±è´¥: ' + error.message, 'error');
            } finally {
              setProcessing(false);
            }
          };

          const downloadLogs = () => {
            const logText = logs.map(log => `[${log.time}] ${log.message}`).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `emby-thumbnail-log-${new Date().toISOString().slice(0, 10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 p-6">
              <div className="max-w-6xl mx-auto">
                <div className="text-center mb-8">
                  <div className="flex items-center justify-center gap-3 mb-2">
                    <Play className="w-10 h-10 text-purple-300" />
                    <h1 className="text-4xl font-bold text-white">Emby å°é¢ç®¡ç†å™¨</h1>
                  </div>
                  <p className="text-purple-200">è‡ªåŠ¨ä» .strm æ–‡ä»¶ç”Ÿæˆè§†é¢‘å°é¢å¹¶ä¸Šä¼ åˆ° Emby</p>
                  
                  <div className="flex items-center justify-center gap-4 mt-4">
                    <div className="flex items-center gap-2 px-3 py-1 bg-white/10 rounded-lg">
                      <User className="w-4 h-4 text-purple-300" />
                      <span className="text-purple-200 text-sm">{username}</span>
                    </div>
                    <button
                      onClick={() => setShowPasswordModal(true)}
                      className="px-3 py-1 bg-blue-500/30 hover:bg-blue-500/50 border border-blue-400/50 rounded-lg text-white text-sm transition-colors flex items-center gap-1"
                    >
                      <Key className="w-3 h-3" />
                      ä¿®æ”¹å¯†ç 
                    </button>
                    <button
                      onClick={onLogout}
                      className="px-3 py-1 bg-red-500/30 hover:bg-red-500/50 border border-red-400/50 rounded-lg text-white text-sm transition-colors flex items-center gap-1"
                    >
                      <LogOut className="w-3 h-3" />
                      ç™»å‡º
                    </button>
                  </div>
                </div>

                <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white/20">
                  <div className="flex items-center justify-between mb-4">
                    <div className="flex items-center gap-2">
                      <Settings className="w-5 h-5 text-purple-300" />
                      <h2 className="text-xl font-bold text-white">é…ç½®ä¿¡æ¯</h2>
                    </div>
                    {savedConfig && (
                      <div className="flex items-center gap-2 px-3 py-1 bg-green-500/20 border border-green-400/30 rounded-lg">
                        <CheckCircle className="w-4 h-4 text-green-300" />
                        <span className="text-green-200 text-sm">å·²ä¿å­˜é…ç½®</span>
                      </div>
                    )}
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-purple-200 text-sm mb-2">Emby æœåŠ¡å™¨åœ°å€</label>
                      <input
                        type="text"
                        placeholder="http://localhost:8096"
                        value={config.embyUrl}
                        onChange={(e) => setConfig({...config, embyUrl: e.target.value})}
                        className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-purple-300/50 focus:outline-none focus:border-purple-400"
                      />
                    </div>

                    <div>
                      <label className="block text-purple-200 text-sm mb-2">Emby API å¯†é’¥</label>
                      <input
                        type="password"
                        placeholder="your-api-key"
                        value={config.embyApiKey}
                        onChange={(e) => setConfig({...config, embyApiKey: e.target.value})}
                        className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-purple-300/50 focus:outline-none focus:border-purple-400"
                      />
                    </div>

                    <div>
                      <label className="block text-purple-200 text-sm mb-2">.strm æ–‡ä»¶ç›®å½•</label>
                      <div className="flex gap-2">
                        <input
                          type="text"
                          placeholder="/path/to/strm/files"
                          value={config.strmDir}
                          onChange={(e) => setConfig({...config, strmDir: e.target.value})}
                          className="flex-1 px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-purple-300/50 focus:outline-none focus:border-purple-400"
                        />
                        <button
                          onClick={() => openFileBrowser('strm')}
                          className="px-4 py-2 bg-purple-500/30 hover:bg-purple-500/50 border border-purple-400/50 rounded-lg text-white transition-colors"
                        >
                          <FolderOpen className="w-5 h-5" />
                        </button>
                      </div>
                    </div>

                    <div>
                      <label className="block text-purple-200 text-sm mb-2">å°é¢è¾“å‡ºç›®å½•ï¼ˆå¯é€‰ï¼‰</label>
                      <div className="flex gap-2">
                        <input
                          type="text"
                          placeholder="ç•™ç©ºåˆ™ä¿å­˜åˆ° .strm åŒçº§ç›®å½•"
                          value={config.outputDir}
                          onChange={(e) => setConfig({...config, outputDir: e.target.value})}
                          className="flex-1 px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-purple-300/50 focus:outline-none focus:border-purple-400"
                        />
                        <button
                          onClick={() => openFileBrowser('output')}
                          className="px-4 py-2 bg-purple-500/30 hover:bg-purple-500/50 border border-purple-400/50 rounded-lg text-white transition-colors"
                        >
                          <FolderOpen className="w-5 h-5" />
                        </button>
                      </div>
                    </div>

                    <div>
                      <label className="block text-purple-200 text-sm mb-2">å°é¢ç”Ÿæˆæ¨¡å¼</label>
                      <select
                        value={config.coverMode}
                        onChange={(e) => setConfig({...config, coverMode: e.target.value})}
                        className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:border-purple-400"
                      >
                        <option value="1">ä»…ç”Ÿæˆç¼ºå¤±å°é¢ï¼ˆæ¨èï¼‰</option>
                        <option value="2">è¦†ç›–æ‰€æœ‰å·²æœ‰å°é¢</option>
                      </select>
                    </div>

                    <div>
                      <label className="block text-purple-200 text-sm mb-2">å¹¶å‘çº¿ç¨‹æ•°</label>
                      <input
                        type="number"
                        min="1"
                        max="16"
                        value={config.concurrency}
                        onChange={(e) => setConfig({...config, concurrency: e.target.value})}
                        className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:border-purple-400"
                      />
                    </div>

                    <div>
                      <label className="block text-purple-200 text-sm mb-2">æœ€å¤§é‡è¯•æ¬¡æ•°</label>
                      <input
                        type="number"
                        min="0"
                        max="5"
                        value={config.maxRetries}
                        onChange={(e) => setConfig({...config, maxRetries: e.target.value})}
                        className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:border-purple-400"
                      />
                    </div>
                  </div>

                  <div className="flex gap-3 mt-6">
                    <button
                      onClick={testEmbyConnection}
                      disabled={testingConnection}
                      className="px-6 py-2 bg-blue-500/30 hover:bg-blue-500/50 border border-blue-400/50 rounded-lg text-white transition-colors flex items-center gap-2 disabled:opacity-50"
                    >
                      {testingConnection ? <><Loader className="w-4 h-4 animate-spin" />æµ‹è¯•ä¸­...</> : <><CheckCircle className="w-4 h-4" />æµ‹è¯•è¿æ¥</>}
                    </button>
                    <button onClick={saveConfig} className="px-6 py-2 bg-green-500/30 hover:bg-green-500/50 border border-green-400/50 rounded-lg text-white transition-colors flex items-center gap-2">
                      <FileText className="w-4 h-4" />ä¿å­˜é…ç½®
                    </button>
                    <button
                      onClick={startProcessing}
                      disabled={processing}
                      className="flex-1 px-6 py-2 bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-white font-semibold transition-all flex items-center justify-center gap-2"
                    >
                      {processing ? <><Loader className="w-5 h-5 animate-spin" />å¤„ç†ä¸­...</> : <><Play className="w-5 h-5" />å¼€å§‹å¤„ç†</>}
                    </button>
                  </div>
                </div>

                {(processing || progress.total > 0) && (
                  <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white/20">
                    <div className="flex items-center justify-between mb-4">
                      <h3 className="text-lg font-bold text-white">å¤„ç†è¿›åº¦</h3>
                      <span className="text-purple-200">{progress.processed} / {progress.total}</span>
                    </div>
                    <div className="w-full bg-white/10 rounded-full h-3 mb-4 overflow-hidden">
                      <div
                        className="bg-gradient-to-r from-purple-500 to-blue-500 h-3 rounded-full transition-all duration-500"
                        style={{ width: `${progress.total > 0 ? (progress.processed / progress.total) * 100 : 0}%` }}
                      />
                    </div>
                    <div className="grid grid-cols-3 gap-4 text-center">
                      <div className="bg-green-500/20 rounded-lg p-3 border border-green-400/30">
                        <div className="text-2xl font-bold text-green-400">{progress.success}</div>
                        <div className="text-sm text-purple-200">æˆåŠŸ</div>
                      </div>
                      <div className="bg-red-500/20 rounded-lg p-3 border border-red-400/30">
                        <div className="text-2xl font-bold text-red-400">{progress.failed}</div>
                        <div className="text-sm text-purple-200">å¤±è´¥</div>
                      </div>
                      <div className="bg-blue-500/20 rounded-lg p-3 border border-blue-400/30">
                        <div className="text-2xl font-bold text-blue-400">{progress.total - progress.processed}</div>
                        <div className="text-sm text-purple-200">å¾…å¤„ç†</div>
                      </div>
                    </div>
                    
                    {failedFiles.length > 0 && !processing && (
                      <button
                        onClick={retryFailed}
                        className="w-full mt-4 px-4 py-2 bg-orange-500/30 hover:bg-orange-500/50 border border-orange-400/50 rounded-lg text-white transition-colors flex items-center justify-center gap-2"
                      >
                        <RefreshCw className="w-4 h-4" />
                        æ‰‹åŠ¨é‡è¯•å¤±è´¥çš„æ–‡ä»¶ ({failedFiles.length})
                      </button>
                    )}
                  </div>
                )}

                {logs.length > 0 && (
                  <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                    <div className="flex items-center justify-between mb-4">
                      <h3 className="text-lg font-bold text-white">å¤„ç†æ—¥å¿—</h3>
                      <div className="flex gap-2">
                        <button onClick={downloadLogs} className="text-sm px-3 py-1 bg-blue-500/30 hover:bg-blue-500/50 border border-blue-400/50 rounded text-purple-200 hover:text-white transition-colors flex items-center gap-1">
                          <Download className="w-3 h-3" />ä¸‹è½½
                        </button>
                        <button onClick={() => setLogs([])} className="text-sm px-3 py-1 bg-red-500/30 hover:bg-red-500/50 border border-red-400/50 rounded text-purple-200 hover:text-white transition-colors flex items-center gap-1">
                          <Trash2 className="w-3 h-3" />æ¸…ç©º
                        </button>
                      </div>
                    </div>
                    <div className="bg-black/30 rounded-lg p-4 max-h-96 overflow-y-auto font-mono text-sm">
                      {logs.map((log, idx) => (
                        <div key={idx} className={`mb-1 ${log.type === 'success' ? 'text-green-300' : log.type === 'error' ? 'text-red-300' : log.type === 'warning' ? 'text-yellow-300' : 'text-purple-200'}`}>
                          <span className="text-gray-400">[{log.time}]</span> {log.message}
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {showBrowser && (
                  <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-gradient-to-br from-purple-900 to-blue-900 rounded-2xl p-6 max-w-3xl w-full max-h-[80vh] flex flex-col border border-white/20">
                      <div className="flex items-center justify-between mb-4">
                        <h3 className="text-xl font-bold text-white">é€‰æ‹©æ–‡ä»¶å¤¹</h3>
                        <button onClick={() => setShowBrowser(false)} className="text-purple-200 hover:text-white transition-colors text-2xl">âœ•</button>
                      </div>
                      
                      <div className="bg-black/30 rounded-lg p-3 mb-4 flex items-center gap-2">
                        <FolderOpen className="w-4 h-4 text-purple-300" />
                        <p className="text-purple-200 text-sm font-mono flex-1 truncate">{currentPath || '/'}</p>
                      </div>

                      {loadingTree ? (
                        <div className="flex items-center justify-center py-12">
                          <Loader className="w-8 h-8 text-purple-300 animate-spin" />
                        </div>
                      ) : (
                        <div className="bg-white/10 rounded-lg flex-1 overflow-y-auto mb-4">
                          {fileTree.length === 0 ? (
                            <div className="p-8 text-center text-purple-300">
                              <AlertCircle className="w-12 h-12 mx-auto mb-2 opacity-50" />
                              <p>ç›®å½•ä¸ºç©ºæˆ–æ— æ³•è®¿é—®</p>
                            </div>
                          ) : (
                            fileTree.map((item, idx) => (
                              <button
                                key={idx}
                                onClick={() => navigateFolder(item)}
                                className="w-full px-4 py-3 flex items-center gap-3 hover:bg-white/10 transition-colors text-left border-b border-white/5 last:border-0"
                              >
                                {item.type === 'directory' ? (
                                  <FolderOpen className="w-5 h-5 text-yellow-400 flex-shrink-0" />
                                ) : (
                                  <FileText className="w-5 h-5 text-blue-400 flex-shrink-0" />
                                )}
                                <span className="text-white flex-1 truncate">{item.name}</span>
                                {item.type === 'directory' && (
                                  <span className="text-purple-300 text-xs">â†’</span>
                                )}
                              </button>
                            ))
                          )}
                        </div>
                      )}

                      <div className="flex gap-3">
                        <button
                          onClick={() => setShowBrowser(false)}
                          className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 border border-white/20 rounded-lg text-white transition-colors"
                        >
                          å–æ¶ˆ
                        </button>
                        <button
                          onClick={selectCurrentFolder}
                          className="flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 rounded-lg text-white font-semibold transition-all"
                        >
                          é€‰æ‹©æ­¤ç›®å½•
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {/* ä¿®æ”¹å¯†ç å¼¹çª— */}
                {showPasswordModal && (
                  <PasswordModal 
                    token={token} 
                    onClose={() => setShowPasswordModal(false)} 
                    onSuccess={onLogout}
                  />
                )}

                <div className="text-center mt-6">
                  <p className="text-purple-300 text-sm">
                    åç«¯æœåŠ¡çŠ¶æ€: <span className={apiConnected ? 'text-green-400' : 'text-gray-400'}>
                      {apiConnected ? 'â— å·²è¿æ¥' : 'â—‹ æœªè¿æ¥'}
                    </span>
                  </p>
                </div>
              </div>
            </div>
          );
        }

        function PasswordModal({ token, onClose, onSuccess }) {
          const [oldPassword, setOldPassword] = useState('');
          const [newPassword, setNewPassword] = useState('');
          const [confirmPassword, setConfirmPassword] = useState('');
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState('');
          const [success, setSuccess] = useState(false);

          const handleSubmit = async (e) => {
            e.preventDefault();
            setError('');

            if (newPassword !== confirmPassword) {
              setError('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
              return;
            }

            if (newPassword.length < 6) {
              setError('æ–°å¯†ç é•¿åº¦è‡³å°‘ä¸º 6 ä½');
              return;
            }

            setLoading(true);

            try {
              const response = await fetch(`${window.location.origin}/api/auth/change-password`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ oldPassword, newPassword })
              });

              const data = await response.json();

              if (data.success) {
                setSuccess(true);
                setTimeout(() => {
                  onSuccess();
                }, 2000);
              } else {
                setError(data.error || 'ä¿®æ”¹å¤±è´¥');
              }
            } catch (err) {
              setError('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
            } finally {
              setLoading(false);
            }
          };

          return (
            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
              <div className="bg-gradient-to-br from-purple-900 to-blue-900 rounded-2xl p-6 max-w-md w-full border border-white/20">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-xl font-bold text-white flex items-center gap-2">
                    <Key className="w-5 h-5" />
                    ä¿®æ”¹å¯†ç 
                  </h3>
                  <button
                    onClick={onClose}
                    className="text-purple-200 hover:text-white transition-colors text-2xl"
                  >
                    âœ•
                  </button>
                </div>

                {success ? (
                  <div className="bg-green-500/20 border border-green-400/50 rounded-lg p-4 text-center">
                    <CheckCircle className="w-12 h-12 text-green-300 mx-auto mb-2" />
                    <p className="text-green-200">å¯†ç ä¿®æ”¹æˆåŠŸï¼</p>
                    <p className="text-green-300 text-sm mt-1">æ­£åœ¨é‡æ–°ç™»å½•...</p>
                  </div>
                ) : (
                  <form onSubmit={handleSubmit} className="space-y-4">
                    {error && (
                      <div className="bg-red-500/20 border border-red-400/50 rounded-lg p-3 flex items-center gap-2">
                        <AlertCircle className="w-5 h-5 text-red-300" />
                        <span className="text-red-200 text-sm">{error}</span>
                      </div>
                    )}

                    <div>
                      <label className="block text-purple-200 text-sm mb-2">åŸå¯†ç </label>
                      <input
                        type="password"
                        value={oldPassword}
                        onChange={(e) => setOldPassword(e.target.value)}
                        className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-purple-300/50 focus:outline-none focus:border-purple-400"
                        required
                      />
                    </div>

                    <div>
                      <label className="block text-purple-200 text-sm mb-2">æ–°å¯†ç </label>
                      <input
                        type="password"
                        value={newPassword}
                        onChange={(e) => setNewPassword(e.target.value)}
                        className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-purple-300/50 focus:outline-none focus:border-purple-400"
                        required
                        minLength="6"
                      />
                    </div>

                    <div>
                      <label className="block text-purple-200 text-sm mb-2">ç¡®è®¤æ–°å¯†ç </label>
                      <input
                        type="password"
                        value={confirmPassword}
                        onChange={(e) => setConfirmPassword(e.target.value)}
                        className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-purple-300/50 focus:outline-none focus:border-purple-400"
                        required
                        minLength="6"
                      />
                    </div>

                    <div className="flex gap-3 mt-6">
                      <button
                        type="button"
                        onClick={onClose}
                        className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 border border-white/20 rounded-lg text-white transition-colors"
                      >
                        å–æ¶ˆ
                      </button>
                      <button
                        type="submit"
                        disabled={loading}
                        className="flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 disabled:opacity-50 rounded-lg text-white font-semibold transition-all"
                      >
                        {loading ? 'æäº¤ä¸­...' : 'ç¡®è®¤ä¿®æ”¹'}
                      </button>
                    </div>
                  </form>
                )}
              </div>
            </div>
          );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>