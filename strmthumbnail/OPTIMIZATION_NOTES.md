# 性能优化说明

## 已完成的优化

### 1. 移除 Emby 上传功能
- ✅ 删除后端 `/api/test-emby` 接口
- ✅ 删除 `uploadToEmby` 函数
- ✅ 移除前端 Emby 服务器配置 UI
- ✅ 简化处理流程，专注于本地封面生成

### 2. 智能并发控制和任务队列
**优化前：**
- 使用简单的分块并发，固定并发数
- 不考虑文件数量，可能导致资源浪费或性能不足

**优化后：**
- ✅ 实现 `TaskQueue` 类，智能管理任务队列
- ✅ 动态调整并发数：
  - 少于 10 个文件：最多 2 并发
  - 10-100 个文件：使用用户配置的并发数
  - 超过 100 个文件：自动增加 1.5 倍并发（最多 8）
- ✅ 更好的资源利用率和处理速度

### 3. 优化 ffprobe/ffmpeg 调用
**优化前：**
- 超时时间较长（15s）
- 使用完整的 ffprobe 命令
- 每次都需要完整探测

**优化后：**
- ✅ 减少超时时间到 10s，提高响应速度
- ✅ 使用 `-select_streams v:0` 仅选择视频流，加快探测
- ✅ curl 下载超时从 30s 减少到 20s
- ✅ curl 使用 `-r` 参数替代 `--range`，更标准
- ✅ ffmpeg 截图添加缩放优化：
  - 最大分辨率限制为 1920x1080
  - 保持原始宽高比
  - 减少输出文件大小

### 4. 缓存机制
**优化前：**
- 每次处理都需要重新获取视频时长
- 重复处理相同视频浪费时间

**优化后：**
- ✅ 实现视频时长缓存系统
- ✅ 使用 Map 存储缓存，键为 `duration:${videoUrl}`
- ✅ 缓存持久化到 `.video_cache.json` 文件
- ✅ 每 5 分钟自动保存缓存
- ✅ 服务器退出时保存缓存
- ✅ 启动时自动加载历史缓存

### 5. 内存优化
- ✅ 在 `finally` 块中清理临时文件，确保一定执行
- ✅ getVideoDuration 函数内部自动清理临时文件
- ✅ 优化临时文件管理，避免内存泄漏

## 性能提升预期

1. **处理速度提升 30-50%**
   - 缓存机制避免重复探测
   - 优化的 ffmpeg 参数减少处理时间
   - 智能并发控制提高吞吐量

2. **网络请求优化**
   - HEAD 请求超时从 10s 减少到 8s
   - curl 超时从 30s 减少到 20s
   - ffprobe 超时从 15s 减少到 10s

3. **内存占用降低**
   - 更及时的临时文件清理
   - 图片缩放减少输出文件大小

4. **用户体验改善**
   - 更快的响应时间
   - 更准确的进度显示
   - 智能的并发调整

## 配置建议

- **并发数设置：**
  - 1-2 核 CPU：设置 2-3
  - 4 核 CPU：设置 4-6
  - 8 核及以上：设置 6-8

- **重试次数：**
  - 建议设置 1-2 次
  - 过多重试会增加总处理时间

## 文件变更

- `server.js`: 核心优化代码
- `public/index.html`: 移除 Emby 相关 UI
- `.video_cache.json`: 新增缓存文件（自动生成）

## 使用说明

1. 启动服务：`npm start` 或 `./start.sh`
2. 访问：`http://localhost:3000`
3. 首次登录：`admin` / `emby123456`（请立即修改密码）
4. 配置 .strm 文件目录
5. 开始处理

## 注意事项

- 缓存文件 `.video_cache.json` 会持续增长，建议定期清理旧条目
- 临时目录 `/tmp/emby_thumb_temp` 会自动清理失败的下载文件
- Windows 用户可能需要调整临时目录路径
